name: Validate Version (Release)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to validate (vX.Y.Z)'
        required: false

env:
  TAG_NAME: ${{ inputs.tag || github.event.release.tag_name || github.ref_name }}

jobs:
  validate-version:
    name: Validate package.json version matches tag
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG_NAME }}

      - name: Extract version from tag
        id: tag_version
        run: |
          # Extract version from tag (e.g., v2.5.5 -> 2.5.5)
          TAG_VERSION="${TAG_NAME#v}"
          echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $TAG_VERSION"

      - name: Extract version from package.json
        id: package_version
        run: |
          # Read version from package.json
          PACKAGE_VERSION=$(node -p "require('./auto-codex-ui/package.json').version")
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "Package.json version: $PACKAGE_VERSION"

      - name: Compare versions
        run: |
          TAG_VERSION="${{ steps.tag_version.outputs.version }}"
          PACKAGE_VERSION="${{ steps.package_version.outputs.version }}"

          echo "=========================================="
          echo "Version Validation"
          echo "=========================================="
          echo "Git tag version:      v$TAG_VERSION"
          echo "package.json version: $PACKAGE_VERSION"
          echo "=========================================="

          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo ""
            echo "❌ ERROR: Version mismatch detected!"
            echo ""
            echo "The version in package.json ($PACKAGE_VERSION) does not match"
            echo "the git tag version ($TAG_VERSION)."
            echo ""
            echo "To fix this:"
            echo "  1. Delete this tag: git tag -d v$TAG_VERSION"
            echo "  2. Update package.json version to $TAG_VERSION"
            echo "  3. Commit the change"
            echo "  4. Recreate the tag: git tag -a v$TAG_VERSION -m 'Release v$TAG_VERSION'"
            echo ""
            echo "Or use the automated script:"
            echo "  node scripts/bump-version.js $TAG_VERSION"
            echo ""
            exit 1
          fi

          echo ""
          echo "✅ SUCCESS: Versions match!"
          echo ""

      - name: Version validation result
        if: success()
        run: |
          echo "::notice::Version validation passed - package.json version matches tag v${{ steps.tag_version.outputs.version }}"
